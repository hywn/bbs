<!-- HTML for submitting a new comment (calls submit.php) -->
<h1>viewing</h1>
<form method="post" action="submit.php">
	<input id="pid_input" type="hidden" name="pid" value="oop">
	<table>
		<tr><td id="prompt_input"></td><td><textarea placeholder="your message here" name="comment"></textarea></td></tr>
		<tr><td></td><td><input type="submit" /></td></tr>
	</table>
</form>

<div id="posts"></div>

<style>
dl { margin: 0 }
blockquote { padding: 0.5em; border-left: 2px solid; overflow-x: auto }
html { display: flex; justify-content: center }
body { width: 32em }
img { width: 100% }
</style>

<script>;(async () => {

const ID = new URLSearchParams(window.location.search).get('id') || 'main'

document.querySelector('#pid_input').setAttribute('value', ID)
document.querySelector('#prompt_input').innerText = `reply to ${ID}:`

const parts = ID.split('.')

document.querySelector('h1').innerHTML = `viewing ${
	parts.map((name, i) => `<a href="?id=${parts.slice(0, i + 1).join('.')}">${name}</a>`).join('.')
}`

const [parent, child] = parts.length >= 2
	? [parts.slice(0, parts.length - 1).join('.'), +parts[parts.length - 1]]
	: [ID, null]

const json = await fetch(`./get_posts.php?pid=${parent}`)
	.then(r => r.json())

const posts = child
	? json.filter(({ id }) => id === child)
	: json

const display_content =
	content =>
		content
			.replace(/\n/g, '<br/>')
			.replace(/\!\[.*?\]\((.+?)\)/g, '<img src="$1"/>')

const display =
	post => `
		<dt>
			${post.id}: (display date here) <a href="?id=${post.parent}.${post.id}">[view/reply]</a>
			<blockquote>${display_content(post.comment)}</blockquote>

		</dt>
		<dd><dl>${post.children.map(display).join('')}</dl></dd>
	`

document.querySelector('#posts').innerHTML = `<dl>${posts.map(display).join('')}</dl>`

})();</script>